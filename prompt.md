
---

# MVSEP TUI 项目完整设计与发展报告（维护交接版）

## 1. 项目定位（Project Scope）

**MVSEP TUI** 是一个：

* 面向 **高级用户 / 研究者 / 工程用户**
* 基于 `curses` 的 **纯终端交互式推理/训练前端**
* 核心目标：**快速配置字段并执行推理/训练**

明确不做：

* WebUI / GUI
* 前端语法强校验
* 新手向引导式交互

> 使用 TUI 的用户被假定熟悉路径、命令、配置文件。

---

## 2. 总体架构原则

### 2.1 只增不删原则

* **已有功能一律保留**
* 新功能尽量**增加代码**而非删减
* 大量删减意味着设计偏离
* **允许在不破坏设计架构的前提下少量删减**
* **若设计架构本身出现了问题，需要对该架构出错的部分进行重构**

### 2.2 前端职责边界

前端只负责：

* 字段编辑
* 简单存在性检查（空值不发送）
* 预览与补全
* 用户操作流管理
* **界面间的切换与状态管理**
* **安全的绘制与输入处理**

前端不负责：

* 参数合法性校验
* 路径是否存在
* enum / bool / num 的语义正确性
* 推理/训练运行失败处理

> "出错是用户自己的责任"

---

## 3. 核心概念模型

### 3.1 Screen（界面）

* **当前支持**：`inference`（推理配置）、`train`（训练配置）
* **界面切换**：通过 `F2` 键切换
* **规则**：每个界面有独立的字段绑定和可见性配置
* **状态管理**：ESC 从子界面返回父界面

### 3.2 Mode（操作模式）

* `VIEW`：浏览字段（在推理界面下显示进程列表）
* `EDIT`：编辑字段
* `COMMAND`：输入命令
* `HELP`：帮助界面（悬浮层）

规则：

* Mode ≠ Screen
* Mode 切换不改变 Screen
* ESC 行为：
  * `EDIT / COMMAND` → 当前 Screen 的 `VIEW`
  * `HELP` → 返回打开 help 的 Mode + Screen

### 3.3 状态管理（重构后）

* **TUIState 类**：统一管理所有界面状态，解决索引错位问题
* **VIEW 模式**：使用 `current_visible_index` 定位可见字段
* **EDIT 模式**：使用 `editing_field_id` 定位编辑字段，避免索引错位
* **状态分离**：VIEW 与 EDIT 状态完全分离，通过字段 ID 关联

---

## 4. 字段系统（Field System）

### 4.1 全局字段结构

```python
{
  "id": int,       # 唯一（不同界面使用不同ID范围）
  "name": str,     # UI展示，也是命令参数键名
  "type": "path|enum|bool|num",
  "default": Any,
  "value": Any,
  "options": List[str]  # 仅enum类型需要
}
```

### 4.2 类型行为

* **path**：任意字符串，动态预览目录/文件
* **enum**：固定列表，独立绑定
* **bool**：共享 `["True","False"]`，输入任意字符串后自动转换
* **num**：数字类型，支持整数和浮点数输入，提供常用值预览

### 4.3 安全字段访问（重构后）

* **统一通过 ID 访问**：`get_field_by_id(field_id)`
* **安全获取可见字段**：`get_visible_fields()` 考虑调试模式
* **防御性处理**：所有字段访问都经过空值检查

### 4.4 界面字段绑定

#### 推理界面字段绑定（11个字段，7个默认可见）：
- **model_type** (enum, 可见)：模型类型
- **preset** (path, 可见)：预设配置文件路径
- **config_path** (path, 可见)：配置文件路径
- **start_check_point** (path, 可见)：检查点路径
- **input_folder** (path, 可见)：输入文件夹
- **store_dir** (path, 可见)：输出文件夹
- **extract_instrumental** (bool, 可见)：是否提取伴奏
- **device_ids** (enum, 隐藏)：设备ID
- **num_workers** (num, 隐藏)：工作进程数
- **verbose** (bool, 隐藏)：详细输出
- **float32** (bool, 隐藏)：使用float32精度

#### 训练界面字段绑定（8个字段，全部可见）：
- **model_type** (enum, 可见)：模型类型
- **config_path** (path, 可见)：配置文件路径
- **start_check_point** (path, 可见)：检查点路径
- **results_path** (path, 可见)：结果输出路径
- **data_path** (path, 可见)：训练数据路径
- **valid_path** (path, 可见)：验证数据路径
- **num_workers** (num, 可见)：工作进程数
- **device_ids** (enum, 可见)：设备ID

### 4.5 字段可见性规则

* **默认模式**：只显示 `visible: true` 的字段
* **调试模式**：显示所有字段，隐藏字段标记为 `[隐藏]`
* **存储**：无论可见性，所有字段值都会被保存和加载
* **命令构建**：所有字段（包括隐藏字段）的值都用于构建命令

---

## 5. 预览系统（Preview System）

* **生成规则**：
  * path → 动态解析目录内容（支持空值安全处理）
  * enum → 固定列表过滤
  * bool → 全局列表 `["True","False"]`
  * num → 常用数字列表 `["1","2","4","8","16","32","64"]`

* **安全预览处理（重构后）**：
  * 所有路径预览都经过 `safe_path_preview()` 处理
  * 处理空值、权限错误、路径不存在等边界情况
  * 预览项数量限制，避免界面溢出

* **排列**：列式优先（column-major）

* **布局限制**：
  * 预览区保留最后一行给命令栏
  * 不纵向无限扩展
  * 横向列超出截断

---

## 6. 编辑系统（Edit）

### 6.1 编辑界面
* 所有字段类型统一编辑 UI
* bool 和 num 类型也允许输入任意字符串，编辑后自动转换
* 光标反显，末尾显示反显空格

### 6.2 编辑系统重构（EditSystem 类）
* **专门处理编辑逻辑**：退格、删除、字符输入、Tab补全、Enter确认
* **类型安全转换**：根据字段类型自动转换输入值
* **预览实时更新**：编辑时动态更新预览项

### 6.3 快捷键
* Enter → 确认编辑，写入 value（自动类型转换）
* ESC → 放弃编辑
* Tab → 补全预览项
* Ctrl+U → 清空编辑
* Ctrl+C → 安全退出（不显示堆栈）

---

## 7. 命令系统（Command Mode）

### 7.1 命令栏
* 永远在最底部
* 单行，不换行，超出上移
* **安全绘制**：使用 `safe_addstr` 防止越界

### 7.2 支持命令

| 命令               | 说明                     | 适用界面       |
|------------------|------------------------|--------------|
| :q               | 退出程序（自动终止所有进程）     | 所有界面       |
| :run             | 执行当前界面的命令           | inference/train |
| :kill <pid/id>   | 终止指定进程              | inference     |
| :kill all        | 终止所有进程              | inference     |
| :ps              | 显示进程状态              | inference     |
| :save [file]     | 另存当前界面字段配置         | 所有界面       |
| :import <file>   | 导入字段配置到当前界面       | 所有界面       |
| :language <lang> | 切换语言                 | 所有界面       |
| :help            | 打开帮助                 | 所有界面       |

### 7.3 Run 命令注意事项（重构后）
* **构造参数**：基于当前界面的所有字段（包括隐藏字段），通过 `field_mapping` 转换为对应参数
* **空值排除**：空字段（None、空字符串）不会包含在命令中
* **布尔值处理**：只有 `True` 值才添加参数，`False` 不添加
* **执行环境**：在独立命令行窗口执行
* **进程管理**：支持多进程同时运行，每个进程有唯一ID
* **进程显示**：在推理界面的VIEW模式下显示进程列表
* **交互限制**：运行进程时编辑模式被禁用
* **终止支持**：支持按ID/PID终止单个进程或终止所有进程
* **预设字段**：`preset` 字段仅用于界面操作，不传递给命令

---

## 8. 缓存 / 保存 / 导入

### 8.1 缓存系统
* **文件**：`mvsep_cache.json`
* **结构**：支持界面层级存储，与旧版本兼容
* **加载**：自动加载，覆盖默认值，加载所有字段（无论可见性）
* **保存**：编辑/推理后自动保存所有字段（无论可见性）

### 8.2 Save As
* 手动另存当前界面所有字段配置
* 不影响缓存文件
* 文件格式与界面字段一致

### 8.3 Import
* 直接导入配置到当前界面所有字段
* 不校验、不提示冲突
* 支持旧版本扁平结构文件

---

## 9. Help 系统
* 悬浮层，ESC 返回原界面 + Mode
* 全局统一，包含所有界面命令说明
* 命令在某界面不可用会在说明中注明
* 包含调试模式说明和隐藏字段操作指南
* **新增 Ctrl+C 处理说明**

---

## 10. Debug 系统（Ctrl+D）
* **状态显示**：右对齐 `Debug=ON/OFF`
* **双解释机制**：文字解释 + 命令解释
* **字段可见性控制**：
  * Debug OFF → 只显示可见字段
  * Debug ON → 显示所有字段（隐藏字段标记为`[隐藏]`）
* **优先显示规则**：
  * Debug OFF → 文字解释
  * Debug ON → 命令解释（若存在）
* **安全绘制**：所有绘制都经过边界检查

---

## 11. 全局快捷键

| 快捷键       | 功能                     | 备注                         |
|------------|------------------------|----------------------------|
| F2         | 切换推理/训练界面           |                            |
| ESC        | 返回上级/取消              |                            |
| **Ctrl+D** | **切换调试模式**           | **控制字段可见性和调试信息**      |
| **Ctrl+C** | **安全退出程序**           | **不显示Python堆栈，终止所有进程** |
| Ctrl+U     | 清空当前输入               |                            |
| Tab        | 预览项补全                |                            |
| ↑/↓        | 字段/进程列表导航           |                            |
| Space      | 切换字段选择/进程选择模式     | 仅推理界面                    |
| Enter      | 编辑字段/查看选中进程详情     |                            |
| k          | 终止选中的进程（仅在进程选择模式） | 仅推理界面                    |

---

## 12. ESC 行为总表

| 当前状态           | Esc 行为               |
|-----------------|----------------------|
| EDIT            | 放弃编辑 → VIEW         |
| COMMAND         | 放弃命令 → VIEW         |
| HELP            | 返回原界面              |
| 进程选择模式         | 返回字段选择模式          |

> 界面切换使用 F2，ESC 不用于界面切换

---

## 13. 多语言系统
* 默认中文
* 通过 `:language <lang>` 切换
* UI 文案必须来自 `LANGS`
* 已支持：中文 (zh)、英文 (en)
* 新增进程管理、界面切换、调试模式相关文本

---

## 14. 进程管理系统（已实现）

### 14.1 核心组件
* **ProcessManager 类**：管理多个推理进程
* **进程状态**：running, completed, killed, failed
* **进程信息**：ID, PID, 命令, 状态, 启动时间

### 14.2 主要功能
1. **多进程支持**：允许多个推理任务同时运行
2. **进程监控**：自动跟踪进程状态变化
3. **进程终止**：支持按ID/PID终止或终止所有
4. **进程清理**：自动清理已完成进程，保留最近记录
5. **界面集成**：在推理界面VIEW模式下显示进程列表

### 14.3 界面交互
* **进程列表**：显示在预览栏区域
* **进程选择**：使用 ↑/↓ 键导航，Space 切换模式
* **进程操作**：Enter 查看详情，k 终止选中进程

### 14.4 命令窗口
* **Windows**：使用 `cmd /c start cmd /k` 创建新窗口
* **Linux/macOS**：尝试多种终端模拟器（x-terminal-emulator, gnome-terminal等）
* **回退方案**：如果没有终端模拟器，在当前终端运行

---

## 15. 安全绘制系统（重构后）

### 15.1 安全绘制函数
* **safe_addstr()**：自动处理边界，防止curses越界
* **safe_draw_fields()**：安全绘制字段列表
* **safe_draw_edit_buffer()**：安全绘制编辑缓冲区
* **safe_draw_preview_column_major()**：安全绘制预览项
* **safe_draw_process_list()**：安全绘制进程列表

### 15.2 边界处理原则
* 永远不假设窗口足够大
* 所有绘制前检查窗口边界
* 所有文本显示前进行截断
* 处理 None 值和空字符串

### 15.3 错误处理
* 忽略绘制错误，不崩溃
* 保持界面稳定，即使绘制出错

---

## 16. 扩展指南与未来发展方向

### 16.1 已实现功能
1. **推理进程管理**
   - 完整 Run 命令输出管理（实现inference命令参数的真正拼接）
   - 唤起另一个命令行执行inference命令（非tui所在命令行）
   - 支持在tui命令行kill pid杀死子命令行进程，kill all杀死所有
   - 运行后在进程栏目显示所有子进程和pid号（在预览栏布局）
   - 允许多个推理进程同时存在

2. **多界面系统**
   - train 界面实现
   - 界面切换机制（F2键）
   - 界面独立的字段配置和缓存管理

3. **字段类型扩展**
   - 新增 num 类型支持
   - 增强的预览和编辑支持

4. **字段可见性控制系统**
   - 界面-字段绑定表支持可见性配置
   - 调试模式控制字段显示
   - 隐藏字段标记和操作支持

5. **安全架构重构**
   - TUIState 统一状态管理
   - 安全字段访问系统
   - 编辑系统模块化
   - 安全绘制函数库

### 16.2 可安全扩展
* 新字段类型（list、range、json等）
* 新 Screen（ensemble、download、settings）
* 更复杂的预览系统（模型列表、路径智能提示）
* 字段动态验证提示（不强校验）
* 命令别名和自动补全
* **多路径字段**：支持类似GUI中的分号分隔多路径输入

### 16.3 不要做
* 不要引入 Web / GUI
* 不要强校验用户输入
* 不要拆分 help
* 不要把 Mode 和 Screen 混成状态机
* 不要过度复杂化字段可见性逻辑

### 16.4 未来发展方向
1. **进程管理增强**
   * 进程资源使用监控（GPU内存、显存）
   * 进程优先级管理
   * 进程输出日志查看

2. **智能预览系统**
   * 模型列表动态加载
   * 路径智能补全（支持通配符）
   * 目录树展开预览

3. **参数组合与预设**
   * 参数快速组合保存
   * 预设方案一键加载
   * 参数模板系统

4. **训练界面增强**
   * 训练进度监控
   * 训练结果预览
   * 模型评估集成

5. **多语言扩展**
   * 更多语言支持
   * 动态语言包加载
   * 用户自定义翻译

6. **字段系统增强**
   * 多路径字段支持（用于训练数据路径等）
   * 字段分组和折叠
   * 字段依赖关系（一个字段的值影响其他字段的显示或可选值）

---

## 17. 项目精神

> 这是给"知道自己在干啥的人"的工具
> 不是防呆软件，也不是教学产品
> 维护者应避免替用户担心输错
> 保持简洁、直接、高效的设计理念

### 核心原则：
1. **信任用户**：用户应该知道自己在做什么
2. **最小干预**：只提供必要的帮助，不强制约束
3. **功能导向**：每个功能都有明确的使用场景
4. **渐进增强**：核心功能稳定，高级功能可选
5. **代码透明**：架构清晰，易于理解和扩展
6. **渐进披露**：默认显示常用字段，高级字段在调试模式下可见，避免界面过于复杂
7. **安全可靠**：即使输入错误或界面变化，程序不崩溃

---

## 18. 维护注意事项

### 18.1 代码维护
* 遵循"只增不删"原则，保持向后兼容
* 新增功能时考虑与现有架构的融合
* 保持代码结构清晰，注释充分
* **优先使用安全绘制函数**，避免curses越界

### 18.2 字段管理
* 新增字段时，需要同时在全局字段定义和界面绑定中添加
* 设置合理的默认值和可见性
* 确保字段名称与底层命令行参数名称对应
* 注意字段ID的唯一性（不同界面使用不同范围）

### 18.3 用户支持
* 提供清晰的错误信息，但不做过多解释
* 帮助文档专注于使用场景，而非基础教学
* 鼓励用户自行探索高级功能

### 18.4 测试与验证
* 新功能需在不同终端环境下测试
* 保持与底层推理/训练代码的兼容性
* 定期验证缓存系统的向后兼容性
* 测试字段可见性在不同模式下的表现
* **特别测试边界情况**：小窗口、空值、特殊字符

### 18.5 文档更新
* 每次新增功能后更新设计文档
* 保持设计文档与实际代码一致
* 记录重要的设计决策和变更原因
* 特别关注字段名称变更和可见性调整

---

## 19. 近期重要变更

### 19.1 架构重构（最新）
* **TUIState 类**：统一状态管理，解决索引错位
* **安全字段访问**：统一通过 ID 访问，防御性处理
* **EditSystem 类**：编辑逻辑模块化
* **安全绘制系统**：防止curses越界，处理各种边界情况
* **空值排除功能**：空字段不包含在命令参数中
* **Ctrl+C 安全退出**：优雅处理中断，不显示堆栈

### 19.2 字段系统重构
* **界面-字段绑定表**：增加了 `visible` 属性控制字段显示
* **调试模式集成**：Ctrl+D 现在控制字段可见性
* **隐藏字段支持**：GUI中不显示的字段在TUI中默认隐藏
* **向后兼容**：缓存系统保持兼容性

### 19.3 字段名称统一
* 确保字段名称与GUI和底层命令参数保持一致
* 推理界面：11个字段，7个可见，4个隐藏
* 训练界面：8个字段，全部可见

### 19.4 预设字段处理
* `preset` 字段仅用于界面操作，不传递给命令
* 保持与GUI的预设功能兼容

---

## 20. 重构总结

### 20.1 解决的核心问题
1. **索引不一致问题**：VIEW模式使用visible-index，EDIT模式使用field-id
2. **状态管理混乱**：统一状态管理类，明确模式分离
3. **空值处理不当**：路径预览和字段访问都增加了防御性处理
4. **curses越界**：所有绘制都经过安全包装
5. **中断处理**：Ctrl+C优雅退出，不显示Python堆栈

### 20.2 架构优势
1. **分离关注点**：状态管理、编辑逻辑、显示绘制分离
2. **错误防御**：所有边界情况都有安全处理
3. **可维护性**：模块化设计，便于调试和扩展
4. **用户体验**：稳定的界面，即使输入错误也不崩溃

### 20.3 向后兼容性
1. **字段定义不变**：保持现有的字段结构和ID
2. **缓存格式不变**：使用相同的存储格式
3. **用户交互不变**：快捷键和操作流程保持一致
4. **功能完整性**：所有现有功能都得到保留和增强

---

这份更新后的报告反映了最新的架构设计，特别是安全重构方案和状态管理系统的改进。所有核心变更已整合到相应章节，保持了设计文档的完整性和一致性。